<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StFX Parking - Dashboard</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.12);
      --text:#e7eefc;
      --muted:rgba(231,238,252,0.7);
      --primary:#6ea8ff;
      --primary-2:#8b5cf6;
      --shadow:0 20px 60px rgba(0,0,0,0.45);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(139,92,246,0.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(110,168,255,0.22), transparent 55%),
                  radial-gradient(800px 500px at 50% 90%, rgba(53,211,157,0.15), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .wrap{width:min(860px,100%);}
    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0 0 8px; font-size:22px;}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.4;}
    .pill{
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(231,238,252,0.85);
      white-space:nowrap;
    }

    .panel{
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      padding:16px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#061022;
      font-weight:800;
      font-size:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 16px 40px rgba(110,168,255,0.25);
      transition: transform 140ms ease, filter 140ms ease;
      width:100%;
      text-align:center;
      text-decoration:none;
      display:inline-block;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05);}

    .ghost{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      transition: background 140ms ease, transform 140ms ease;
      text-decoration:none;
      display:inline-block;
      width:100%;
      text-align:center;
    }
    .ghost:hover{background:rgba(255,255,255,0.08); transform:translateY(-1px);}

    .spot{
      font-size:14px;
      margin:8px 0 0;
      color:rgba(231,238,252,0.9);
    }
    .spot strong{color:var(--text);}
    .temp{
      margin-top:8px;
      color:rgba(231,238,252,0.80);
      font-size:13px;
    }
    .temp strong{color:var(--text);}

    .message{
      margin-top:12px;
      font-size:12px;
      padding:10px 12px;
      border-radius:14px;
      display:none;
      border:1px solid transparent;
    }
    .message.success{
      display:block;
      border-color: rgba(53,211,157,0.35);
      background: rgba(53,211,157,0.12);
      color: rgba(201,255,239,0.98);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1 id="welcomeTitle">Welcome to StFX Parking!</h1>
          <p class="sub">Choose an option below.</p>
          <p class="spot" id="spotLine">Your allocated parking spot is <strong>Not allocated</strong>.</p>
          <p class="temp" id="tempLine" style="display:none;"></p>
        </div>
        <div class="pill" id="userPill">User: â€”</div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 8px; font-size:16px;">Actions</h3>
        <p style="margin:0; color:rgba(231,238,252,0.7); font-size:13px; line-height:1.4;">
          Select what you would like to do:
        </p>

        <div class="row">
          <a class="btn" href="parking-lots.html">1) View Parking Lots</a>
          <a class="ghost" href="manage-spot.html">2) Manage Parking Spot</a>
          <a class="ghost" href="report-taken.html">3) Report Parking Spot Taken</a>
        </div>

        <div class="row" style="margin-top:10px;">
          <a class="ghost" href="index.html">Return to Login</a>
          <button class="ghost" id="logoutBtn" type="button">Logout</button>
        </div>

        <div id="msg" class="message"></div>
      </div>
    </div>
  </div>

  <script>

    const ACCESS_CODE = "ABCD-1234-EFGH-5678";

    function migrateLegacyData(){
      // Clear previous demo keys (older version)
      localStorage.removeItem("demo_session");
      localStorage.removeItem("demo_users");

      // Remove any seeded "system" owners from earlier builds
      try{
        const owners = JSON.parse(localStorage.getItem("stfx_spot_owners")) || {};
        let changed = false;
        Object.keys(owners).forEach(lot => {
          Object.keys(owners[lot] || {}).forEach(spot => {
            if(owners[lot][spot] === "system"){
              delete owners[lot][spot];
              changed = true;
            }
          });
          // clean empty lot object
          if(Object.keys(owners[lot] || {}).length === 0){
            // keep as empty for simplicity
          }
        });
        if(changed){
          localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
        }
      }catch(e){}
    }

    function getSession(){
      try { return JSON.parse(localStorage.getItem("stfx_session")); }
      catch { return null; }
    }
    function setSession(username){
      localStorage.setItem("stfx_session", JSON.stringify({username, ts: Date.now()}));
    }
    function clearSession(){
      localStorage.removeItem("stfx_session");
    }

    function getUsers(){
      try { return JSON.parse(localStorage.getItem("stfx_users")) || {}; }
      catch { return {}; }
    }
    function setUsers(users){
      localStorage.setItem("stfx_users", JSON.stringify(users));
    }

    function getProfile(username){
      try {
        const all = JSON.parse(localStorage.getItem("stfx_profiles")) || {};
        return all[username] || {};
      } catch { return {}; }
    }
    function setProfile(username, profile){
      const all = (() => {
        try { return JSON.parse(localStorage.getItem("stfx_profiles")) || {}; }
        catch { return {}; }
      })();
      all[username] = profile;
      localStorage.setItem("stfx_profiles", JSON.stringify(all));
    }

    function getOwners(){
      try { return JSON.parse(localStorage.getItem("stfx_spot_owners")) || {}; }
      catch { return {}; }
    }
    function setOwners(owners){
      localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function cleanupTempSpot(username){
      const profile = getProfile(username);
      if(!profile || !profile.tempDate) return;

      if(profile.tempDate !== todayISO()){
        if(profile.tempParkingLot && profile.tempLotNumber){
          const owners = getOwners();
          const lot = profile.tempParkingLot;
          const spot = profile.tempLotNumber;
          if(owners[lot] && owners[lot][spot] === username){
            delete owners[lot][spot];
            setOwners(owners);
          }
        }

        delete profile.tempDate;
        delete profile.tempParkingLot;
        delete profile.tempLotNumber;
        setProfile(username, profile);
      }
    }

    function requireAuth(){
      migrateLegacyData();
      const s = getSession();
      if(!s || !s.username){
        window.location.href = "index.html";
        return null;
      }
      cleanupTempSpot(s.username);
      return s;
    }

    const userPill = document.getElementById("userPill");
    const welcomeTitle = document.getElementById("welcomeTitle");
    const spotLine = document.getElementById("spotLine");
    const tempLine = document.getElementById("tempLine");

    const s = requireAuth();
    if(!s) throw new Error("Not authenticated");

    const username = s.username;
    userPill.textContent = "User: " + username;

    const users = getUsers();
    const profile = getProfile(username);

    const name = (users[username] && users[username].name) ? users[username].name : (profile.name || "Your Name");
    welcomeTitle.textContent = `Welcome ${name} to StFX Parking!`;

    if(profile.parkingLot && profile.lotNumber){
      spotLine.innerHTML = `Your allocated parking spot is <strong>${profile.parkingLot}, ${profile.lotNumber}</strong>.`;
    } else {
      spotLine.innerHTML = `Your allocated parking spot is <strong>Not allocated</strong>.`;
    }

    // Temporary spot (today only)
    if(profile.tempDate === todayISO() && profile.tempParkingLot && profile.tempLotNumber){
      tempLine.style.display = "block";
      tempLine.innerHTML = `Temporary spot for today: <strong>${profile.tempParkingLot}, ${profile.tempLotNumber}</strong>.`;
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      clearSession();
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
