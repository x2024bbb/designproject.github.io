<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StFX Parking - Login</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.12);
      --text:#e7eefc;
      --muted:rgba(231,238,252,0.7);
      --primary:#6ea8ff;
      --primary-2:#8b5cf6;
      --danger:#ff5a7a;
      --success:#35d39d;
      --shadow:0 20px 60px rgba(0,0,0,0.45);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(139,92,246,0.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(110,168,255,0.22), transparent 55%),
                  radial-gradient(800px 500px at 50% 90%, rgba(53,211,157,0.15), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .wrap{width:min(520px,100%);}
    .brand{
      display:flex; align-items:center; gap:10px;
      margin-bottom:14px; user-select:none;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      box-shadow:0 12px 35px rgba(110,168,255,0.35);
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
    }
    .brand h1{font-size:18px; margin:0; line-height:1.1;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted);}

    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
    }

    .top-row{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px; margin-bottom:10px;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex; gap:6px; padding:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.05);
    }
    .pill button{
      border:none; cursor:pointer;
      padding:8px 12px; border-radius:999px;
      background:transparent;
      color:rgba(231,238,252,0.75);
      font-weight:700; font-size:12px;
      transition:background 140ms ease, color 140ms ease;
      white-space:nowrap;
    }
    .pill button.active{
      background:rgba(255,255,255,0.10);
      color:var(--text);
    }

    h2{margin:0 0 6px; font-size:20px;}
    .subtitle{margin:0 0 16px; color:var(--muted); font-size:13px; line-height:1.4;}

    form{display:grid; gap:12px;}
    .field{display:grid; gap:6px;}
    label{font-size:12px; color:var(--muted);}
    .input{
      display:flex; align-items:center;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:10px 12px;
      transition:border 150ms ease, transform 150ms ease;
    }
    .input:focus-within{border-color:rgba(110,168,255,0.55); transform:translateY(-1px);}
    input{
      width:100%; background:transparent; border:none; outline:none;
      color:var(--text); font-size:14px;
    }
    input::placeholder{color:rgba(231,238,252,0.45);}

    .icon-btn{
      border:none; background:transparent;
      color:rgba(231,238,252,0.75);
      cursor:pointer; padding:6px;
      border-radius:10px; transition:background 120ms ease;
      line-height:0;
    }
    .icon-btn:hover{background:rgba(255,255,255,0.07);}

    .btn{
      margin-top:6px; width:100%;
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#061022; font-weight:800; font-size:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
      box-shadow:0 16px 40px rgba(110,168,255,0.25);
      transition:transform 140ms ease, filter 140ms ease;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05);}

    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:4px;
    }

    .link{color:rgba(110,168,255,0.9); text-decoration:none; font-size:12px;}
    .link:hover{text-decoration:underline;}

    .message{
      margin-top:12px;
      font-size:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      display:none;
    }
    .message.error{
      display:block;
      border-color:rgba(255,90,122,0.35);
      background:rgba(255,90,122,0.12);
      color:rgba(255,215,225,0.98);
    }
    .message.success{
      display:block;
      border-color:rgba(53,211,157,0.35);
      background:rgba(53,211,157,0.12);
      color:rgba(201,255,239,0.98);
    }

    .hint{
      color:rgba(231,238,252,0.55);
      font-size:12px;
      line-height:1.35;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo">XP</div>
      <div>
        <h1>StFX Parking</h1>
        <p>Student parking portal</p>
      </div>
    </div>

    <div class="card">
      <div class="top-row">
        <div>
          <h2 id="title">Welcome back</h2>
          <p class="subtitle" id="subtitle">Login with your username and password.</p>
        </div>

        <div class="pill" aria-label="Switch between Login and First-time Access">
          <button id="tabLogin" class="active" type="button">Login</button>
          <button id="tabAccess" type="button">First-time Access</button>
        </div>
      </div>

      <!-- LOGIN -->
      <form id="loginForm" novalidate>
        <div class="field">
          <label for="loginUser">Username</label>
          <div class="input">
            <input id="loginUser" placeholder="e.g., jsuresh" required />
          </div>
          <div class="hint">Username = your email ID without the web address (example: jsuresh, not jsuresh@stfx.ca).</div>
        </div>

        <div class="field">
          <label for="loginPass">Password</label>
          <div class="input">
            <input id="loginPass" type="password" placeholder="Enter your password" required minlength="6" />
            <button type="button" class="icon-btn" id="toggleLoginPass" aria-label="Show password">üëÅ</button>
          </div>
        </div>

        <button class="btn" type="submit">Sign in</button>
        <div id="loginMsg" class="message"></div>
      </form>

      <!-- ACCESS SIGNUP -->
      <form id="accessForm" style="display:none" novalidate>
        <div class="field">
          <label for="accessCode">Access Code</label>
          <div class="input">
            <input id="accessCode" placeholder="ABCD-1234-EFGH-5678" required />
          </div>
        </div>

        <div class="field">
          <label for="newUser">Create Username</label>
          <div class="input">
            <input id="newUser" placeholder="e.g., jsuresh" required />
          </div>
          <div class="hint">No ‚Äú@domain‚Äù. Letters and numbers only (dots/underscores allowed).</div>
        </div>

        <div class="field">
          <label for="newName">Your Name</label>
          <div class="input">
            <input id="newName" placeholder="e.g., John Suresh" required />
          </div>
        </div>

        <div class="field">
          <label for="newPass">Create Password</label>
          <div class="input">
            <input id="newPass" type="password" placeholder="Minimum 6 characters" required minlength="6" />
            <button type="button" class="icon-btn" id="toggleNewPass" aria-label="Show password">üëÅ</button>
          </div>
        </div>

        <button class="btn" type="submit">Create Account</button>
        <div id="accessMsg" class="message"></div>

        <div class="hint">
          The access code is required only for your first registration.
        </div>
      </form>

      <div class="row" style="margin-top:14px;">
        <a class="link" href="#" id="resetLink">Reset saved login (this device)</a>
      </div>
    </div>
  </div>

  <script>

    const ACCESS_CODE = "ABCD-1234-EFGH-5678";

    function migrateLegacyData(){
      // Clear previous demo keys (older version)
      localStorage.removeItem("demo_session");
      localStorage.removeItem("demo_users");

      // Remove any seeded "system" owners from earlier builds
      try{
        const owners = JSON.parse(localStorage.getItem("stfx_spot_owners")) || {};
        let changed = false;
        Object.keys(owners).forEach(lot => {
          Object.keys(owners[lot] || {}).forEach(spot => {
            if(owners[lot][spot] === "system"){
              delete owners[lot][spot];
              changed = true;
            }
          });
          // clean empty lot object
          if(Object.keys(owners[lot] || {}).length === 0){
            // keep as empty for simplicity
          }
        });
        if(changed){
          localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
        }
      }catch(e){}
    }

    function getSession(){
      try { return JSON.parse(localStorage.getItem("stfx_session")); }
      catch { return null; }
    }
    function setSession(username){
      localStorage.setItem("stfx_session", JSON.stringify({username, ts: Date.now()}));
    }
    function clearSession(){
      localStorage.removeItem("stfx_session");
    }

    function getUsers(){
      try { return JSON.parse(localStorage.getItem("stfx_users")) || {}; }
      catch { return {}; }
    }
    function setUsers(users){
      localStorage.setItem("stfx_users", JSON.stringify(users));
    }

    function getProfile(username){
      try {
        const all = JSON.parse(localStorage.getItem("stfx_profiles")) || {};
        return all[username] || {};
      } catch { return {}; }
    }
    function setProfile(username, profile){
      const all = (() => {
        try { return JSON.parse(localStorage.getItem("stfx_profiles")) || {}; }
        catch { return {}; }
      })();
      all[username] = profile;
      localStorage.setItem("stfx_profiles", JSON.stringify(all));
    }

    function getOwners(){
      try { return JSON.parse(localStorage.getItem("stfx_spot_owners")) || {}; }
      catch { return {}; }
    }
    function setOwners(owners){
      localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function cleanupTempSpot(username){
      const profile = getProfile(username);
      if(!profile || !profile.tempDate) return;

      if(profile.tempDate !== todayISO()){
        if(profile.tempParkingLot && profile.tempLotNumber){
          const owners = getOwners();
          const lot = profile.tempParkingLot;
          const spot = profile.tempLotNumber;
          if(owners[lot] && owners[lot][spot] === username){
            delete owners[lot][spot];
            setOwners(owners);
          }
        }

        delete profile.tempDate;
        delete profile.tempParkingLot;
        delete profile.tempLotNumber;
        setProfile(username, profile);
      }
    }

    function requireAuth(){
      migrateLegacyData();
      const s = getSession();
      if(!s || !s.username){
        window.location.href = "index.html";
        return null;
      }
      cleanupTempSpot(s.username);
      return s;
    }

    const loginForm = document.getElementById("loginForm");
    const accessForm = document.getElementById("accessForm");
    const tabLogin = document.getElementById("tabLogin");
    const tabAccess = document.getElementById("tabAccess");
    const title = document.getElementById("title");
    const subtitle = document.getElementById("subtitle");

    const loginMsg = document.getElementById("loginMsg");
    const accessMsg = document.getElementById("accessMsg");

    function showMsg(el, type, text){
      el.className = "message " + type;
      el.textContent = text;
      el.style.display = "block";
    }
    function hideMsg(el){
      el.style.display = "none";
      el.textContent = "";
      el.className = "message";
    }

    function normalizeUsername(u){
      return (u || "").trim().toLowerCase();
    }

    function isValidUsername(u){
      if(!u) return false;
      if(u.includes("@")) return false;
      // allow letters/numbers/_/.
      return /^[a-z0-9._-]+$/.test(u);
    }

    function setMode(mode){
      hideMsg(loginMsg); hideMsg(accessMsg);
      if(mode === "login"){
        tabLogin.classList.add("active");
        tabAccess.classList.remove("active");
        loginForm.style.display = "grid";
        accessForm.style.display = "none";
        title.textContent = "Welcome back";
        subtitle.textContent = "Login with your username and password.";
      } else {
        tabAccess.classList.add("active");
        tabLogin.classList.remove("active");
        loginForm.style.display = "none";
        accessForm.style.display = "grid";
        title.textContent = "First-time access";
        subtitle.textContent = "Enter the access code once to create your account.";
      }
    }

    function goToDashboard(){
      window.location.href = "dashboard.html";
    }

    // Password toggles
    document.getElementById("toggleLoginPass").addEventListener("click", () => {
      const el = document.getElementById("loginPass");
      el.type = el.type === "password" ? "text" : "password";
    });
    document.getElementById("toggleNewPass").addEventListener("click", () => {
      const el = document.getElementById("newPass");
      el.type = el.type === "password" ? "text" : "password";
    });

    tabLogin.addEventListener("click", () => setMode("login"));
    tabAccess.addEventListener("click", () => setMode("access"));

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      hideMsg(loginMsg);

      const username = normalizeUsername(document.getElementById("loginUser").value);
      const password = document.getElementById("loginPass").value.trim();

      if(!isValidUsername(username)){
        showMsg(loginMsg, "error", "Please enter a valid username (no @domain).");
        return;
      }
      if(password.length < 6){
        showMsg(loginMsg, "error", "Password must be at least 6 characters.");
        return;
      }

      const users = getUsers();
      if(!users[username]){
        showMsg(loginMsg, "error", "No account found. Use First-time Access to create your account.");
        setMode("access");
        return;
      }

      if(users[username].password !== password){
        showMsg(loginMsg, "error", "Incorrect password. Try again.");
        return;
      }

      setSession(username);
      showMsg(loginMsg, "success", "Login successful. Redirecting...");
      setTimeout(goToDashboard, 450);
    });

    accessForm.addEventListener("submit", (e) => {
      e.preventDefault();
      hideMsg(accessMsg);

      const code = document.getElementById("accessCode").value.trim();
      const username = normalizeUsername(document.getElementById("newUser").value);
      const name = document.getElementById("newName").value.trim();
      const password = document.getElementById("newPass").value.trim();

      if(code !== ACCESS_CODE){
        showMsg(accessMsg, "error", "Invalid access code.");
        return;
      }
      if(!isValidUsername(username)){
        showMsg(accessMsg, "error", "Invalid username. Use letters/numbers only (no @domain).");
        return;
      }
      if(!name){
        showMsg(accessMsg, "error", "Please enter your name.");
        return;
      }
      if(password.length < 6){
        showMsg(accessMsg, "error", "Password must be at least 6 characters.");
        return;
      }

      const users = getUsers();
      if(users[username]){
        showMsg(accessMsg, "error", "This username already exists. Please choose another one.");
        return;
      }

      // Create user
      users[username] = { name, password };
      setUsers(users);

      // Create profile defaults (no assigned spot yet)
      const profile = getProfile(username);
      profile.name = name;
      if(!profile.parkingLot) profile.parkingLot = "";
      if(!profile.lotNumber) profile.lotNumber = "";
      setProfile(username, profile);

      setSession(username);
      showMsg(accessMsg, "success", "Account created. Redirecting...");
      setTimeout(goToDashboard, 450);
    });

    // Reset (device)
    document.getElementById("resetLink").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("stfx_session");
      showMsg(loginMsg, "success", "Login reset for this device. You can sign in again.");
      setMode("login");
    });

    // Auto redirect if already logged in
    const s = getSession();
    if(s && s.username){
      goToDashboard();
    } else {
      setMode("login");
    }
  </script>
</body>
</html>
