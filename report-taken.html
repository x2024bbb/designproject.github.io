<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StFX Parking - Report Spot Taken</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,0.06);
      --card-border:rgba(255,255,255,0.12);
      --text:#e7eefc;
      --muted:rgba(231,238,252,0.7);
      --primary:#6ea8ff;
      --primary-2:#8b5cf6;
      --danger:#ff5a7a;
      --success:#35d39d;
      --shadow:0 20px 60px rgba(0,0,0,0.45);
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(139,92,246,0.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(110,168,255,0.22), transparent 55%),
                  radial-gradient(800px 500px at 50% 90%, rgba(53,211,157,0.15), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .wrap{width:min(860px,100%);}
    .card{
      background:var(--card);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    h1{margin:0 0 6px; font-size:20px;}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.4;}

    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .ghost{
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.05);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      transition: background 140ms ease, transform 140ms ease;
      text-decoration:none;
      display:inline-block;
    }
    .ghost:hover{background:rgba(255,255,255,0.08); transform:translateY(-1px);}

    .panel{
      margin-top:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.04);
      padding:16px;
    }

    .spot-line{
      margin:8px 0 0;
      color:rgba(231,238,252,0.9);
      font-size:14px;
    }
    .spot-line strong{color:var(--text);}

    .btn{
      margin-top:12px;
      border:none;
      cursor:pointer;
      padding:12px 14px;
      border-radius:14px;
      color:#061022;
      font-weight:800;
      font-size:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      box-shadow: 0 16px 40px rgba(110,168,255,0.25);
      transition: transform 140ms ease, filter 140ms ease;
      width:100%;
      text-align:center;
    }
    .btn:hover{transform:translateY(-1px); filter:brightness(1.05);}

    .message{
      margin-top:12px;
      font-size:12px;
      padding:10px 12px;
      border-radius:14px;
      display:none;
      border:1px solid transparent;
    }
    .message.success{
      display:block;
      border-color: rgba(53,211,157,0.35);
      background: rgba(53,211,157,0.12);
      color: rgba(201,255,239,0.98);
    }
    .message.error{
      display:block;
      border-color: rgba(255,90,122,0.35);
      background: rgba(255,90,122,0.12);
      color: rgba(255,215,225,0.98);
    }

    .note{
      margin-top:10px;
      color:rgba(231,238,252,0.55);
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Report Parking Spot Taken</h1>
          <p class="sub">If someone is parked in your allocated spot, you can get a temporary spot for today.</p>
          <p class="spot-line" id="allocatedLine">Allocated spot: <strong>â€”</strong></p>
          <p class="spot-line" id="tempLine" style="display:none;"></p>
        </div>
        <div class="nav">
          <a class="ghost" href="dashboard.html">Back to Dashboard</a>
          <a class="ghost" href="parking-lots.html">View Lots</a>
        </div>
      </div>

      <div class="panel">
        <button class="btn" id="assignBtn" type="button">Find Closest Available Spot (Today Only)</button>
        <div id="msg" class="message"></div>

        <div class="note">
          Your original spot stays reserved for you. The temporary spot is only valid for today.
        </div>
      </div>
    </div>
  </div>

  <script>

    const ACCESS_CODE = "ABCD-1234-EFGH-5678";

    function migrateLegacyData(){
      // Clear previous demo keys (older version)
      localStorage.removeItem("demo_session");
      localStorage.removeItem("demo_users");

      // Remove any seeded "system" owners from earlier builds
      try{
        const owners = JSON.parse(localStorage.getItem("stfx_spot_owners")) || {};
        let changed = false;
        Object.keys(owners).forEach(lot => {
          Object.keys(owners[lot] || {}).forEach(spot => {
            if(owners[lot][spot] === "system"){
              delete owners[lot][spot];
              changed = true;
            }
          });
          // clean empty lot object
          if(Object.keys(owners[lot] || {}).length === 0){
            // keep as empty for simplicity
          }
        });
        if(changed){
          localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
        }
      }catch(e){}
    }

    function getSession(){
      try { return JSON.parse(localStorage.getItem("stfx_session")); }
      catch { return null; }
    }
    function setSession(username){
      localStorage.setItem("stfx_session", JSON.stringify({username, ts: Date.now()}));
    }
    function clearSession(){
      localStorage.removeItem("stfx_session");
    }

    function getUsers(){
      try { return JSON.parse(localStorage.getItem("stfx_users")) || {}; }
      catch { return {}; }
    }
    function setUsers(users){
      localStorage.setItem("stfx_users", JSON.stringify(users));
    }

    function getProfile(username){
      try {
        const all = JSON.parse(localStorage.getItem("stfx_profiles")) || {};
        return all[username] || {};
      } catch { return {}; }
    }
    function setProfile(username, profile){
      const all = (() => {
        try { return JSON.parse(localStorage.getItem("stfx_profiles")) || {}; }
        catch { return {}; }
      })();
      all[username] = profile;
      localStorage.setItem("stfx_profiles", JSON.stringify(all));
    }

    function getOwners(){
      try { return JSON.parse(localStorage.getItem("stfx_spot_owners")) || {}; }
      catch { return {}; }
    }
    function setOwners(owners){
      localStorage.setItem("stfx_spot_owners", JSON.stringify(owners));
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function cleanupTempSpot(username){
      const profile = getProfile(username);
      if(!profile || !profile.tempDate) return;

      if(profile.tempDate !== todayISO()){
        if(profile.tempParkingLot && profile.tempLotNumber){
          const owners = getOwners();
          const lot = profile.tempParkingLot;
          const spot = profile.tempLotNumber;
          if(owners[lot] && owners[lot][spot] === username){
            delete owners[lot][spot];
            setOwners(owners);
          }
        }

        delete profile.tempDate;
        delete profile.tempParkingLot;
        delete profile.tempLotNumber;
        setProfile(username, profile);
      }
    }

    function requireAuth(){
      migrateLegacyData();
      const s = getSession();
      if(!s || !s.username){
        window.location.href = "index.html";
        return null;
      }
      cleanupTempSpot(s.username);
      return s;
    }

    const s = requireAuth();
    if(!s) throw new Error("Not authenticated");
    const username = s.username;

    const allocatedLine = document.getElementById("allocatedLine");
    const tempLine = document.getElementById("tempLine");
    const msg = document.getElementById("msg");

    const lotsOrder = [
      "Nasso Family Science Centre",
      "Mulroney",
      "Bloomfield",
      "Bruce Brown",
      "Keating Centre"
    ];

    const lotLayouts = {
      "Nasso Family Science Centre": { type: "simple8" },
      "Mulroney": { type: "simple8" },
      "Keating Centre": { type: "simple8" },
      "Bloomfield": { type: "double16" },
      "Bruce Brown": { type: "double16" }
    };

    function showMessage(type, text){
      msg.className = "message " + type;
      msg.textContent = text;
      msg.style.display = "block";
    }
    function hideMessage(){
      msg.style.display = "none";
      msg.textContent = "";
      msg.className = "message";
    }

    function buildRows(lotName){
      const layout = lotLayouts[lotName] || { type: "simple8" };
      const rows = [];
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

      if(layout.type === "simple8"){
        rows.push({ label: "A", size: 8 });
        rows.push({ label: "B", size: 8 });
        rows.push({ label: "C", size: 8 });
        rows.push({ label: "D", size: 8 });
      } else {
        rows.push({ label: "A", size: 8 });
        for(let i=1;i<=8;i++){
          rows.push({ label: letters[i], size: 16 });
        }
        rows.push({ label: "J", size: 8 });
      }
      return rows;
    }

    function listSpotsInOrder(lotName){
      const rows = buildRows(lotName);
      const spots = [];
      rows.forEach(r => {
        for(let i=1;i<=r.size;i++){
          spots.push(r.label + String(i));
        }
      });
      return spots;
    }

    function ownerOf(lotName, spotId){
      const owners = getOwners();
      return owners?.[lotName]?.[spotId] || null;
    }

    function isAvailable(lotName, spotId){
      return !ownerOf(lotName, spotId);
    }

    function reserveTempSpot(lotName, spotId){
      const owners = getOwners();
      if(!owners[lotName]) owners[lotName] = {};
      owners[lotName][spotId] = username;
      setOwners(owners);

      const p = getProfile(username);
      p.tempDate = todayISO();
      p.tempParkingLot = lotName;
      p.tempLotNumber = spotId;
      setProfile(username, p);
    }

    function refreshLines(){
      const p = getProfile(username);

      if(p.parkingLot && p.lotNumber){
        allocatedLine.innerHTML = `Allocated spot: <strong>${p.parkingLot}, ${p.lotNumber}</strong>`;
      } else {
        allocatedLine.innerHTML = `Allocated spot: <strong>Not allocated</strong>`;
      }

      if(p.tempDate === todayISO() && p.tempParkingLot && p.tempLotNumber){
        tempLine.style.display = "block";
        tempLine.innerHTML = `Temporary spot for today: <strong>${p.tempParkingLot}, ${p.tempLotNumber}</strong>`;
      } else {
        tempLine.style.display = "none";
      }
    }

    function clearExistingTempIfAny(){
      const p = getProfile(username);
      if(p.tempDate && p.tempParkingLot && p.tempLotNumber){
        const owners = getOwners();
        const lot = p.tempParkingLot;
        const spot = p.tempLotNumber;
        if(owners[lot] && owners[lot][spot] === username){
          delete owners[lot][spot];
          setOwners(owners);
        }
        delete p.tempDate;
        delete p.tempParkingLot;
        delete p.tempLotNumber;
        setProfile(username, p);
      }
    }

    function findClosestSpot(){
      const p = getProfile(username);

      // If already has temp spot today, keep it
      if(p.tempDate === todayISO() && p.tempParkingLot && p.tempLotNumber){
        return {lot: p.tempParkingLot, spot: p.tempLotNumber, already: true};
      }

      // Start searching from allocated lot first
      const preferredLot = p.parkingLot || lotsOrder[0];
      const preferredSpot = p.lotNumber || null;

      // Helper: find nearest in the same lot
      function nearestInLot(lotName, referenceSpot){
        const ordered = listSpotsInOrder(lotName);
        if(ordered.length === 0) return null;

        const refIndex = referenceSpot ? ordered.indexOf(referenceSpot) : -1;

        // If reference spot not found, just pick first available
        if(refIndex < 0){
          for(const spot of ordered){
            if(isAvailable(lotName, spot)) return spot;
          }
          return null;
        }

        // Search outward around refIndex
        for(let d=1; d<ordered.length; d++){
          const left = refIndex - d;
          const right = refIndex + d;

          if(left >= 0){
            const s1 = ordered[left];
            if(s1 !== referenceSpot && isAvailable(lotName, s1)) return s1;
          }
          if(right < ordered.length){
            const s2 = ordered[right];
            if(s2 !== referenceSpot && isAvailable(lotName, s2)) return s2;
          }
        }

        return null;
      }

      // 1) Same lot as allocated
      let spot = nearestInLot(preferredLot, preferredSpot);
      if(spot) return {lot: preferredLot, spot};

      // 2) Other lots in order
      for(const lot of lotsOrder){
        if(lot === preferredLot) continue;
        const ordered = listSpotsInOrder(lot);
        for(const s of ordered){
          if(isAvailable(lot, s)) return {lot, spot: s};
        }
      }

      return null;
    }

    refreshLines();

    document.getElementById("assignBtn").addEventListener("click", () => {
      hideMessage();

      const p = getProfile(username);
      if(!p.parkingLot || !p.lotNumber){
        showMessage("error", "You do not have an allocated spot yet. Please choose one first.");
        return;
      }

      // Clear any previous temp spot (so you always get the closest current option)
      clearExistingTempIfAny();

      const result = findClosestSpot();
      if(!result){
        showMessage("error", "No available spots were found.");
        return;
      }

      reserveTempSpot(result.lot, result.spot);
      showMessage("success", `Temporary spot assigned for today: ${result.lot}, ${result.spot}.`);
      refreshLines();
    });
  </script>
</body>
</html>
